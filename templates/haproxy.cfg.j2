global
  log /dev/log local0
  log /dev/log local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
  stats timeout 30s
  user haproxy
  group haproxy
  daemon

defaults
  log global
  mode tcp
  option tcplog
  option dontlognull
  timeout connect 5s
  timeout client 60s
  timeout server 60s

frontend kubernetes-api
  bind *:{{ k8s_ha_api_port }}
  mode tcp
  default_backend kubernetes-api-be

backend kubernetes-api-be
  mode tcp
  balance roundrobin
  option tcp-check
{% for host in groups['k8s_control_plane'] %}
  server {{ host }} {{ hostvars[host]['k8s_private_ip'] | default(hostvars[host]['ansible_host']) }}:{{ k8s_api_server_port }} check
{% endfor %}
